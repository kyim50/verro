name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Automatic npm caching

      # 3Ô∏è‚É£ Install backend dependencies
      - name: Install backend dependencies
        working-directory: ./erato-app/backend
        run: npm ci

      # 4Ô∏è‚É£ Run backend tests (non-blocking)
      - name: Run backend tests
        working-directory: ./erato-app/backend
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test || echo "No tests configured or tests skipped"
          else
            echo "No tests configured"
          fi
        continue-on-error: true

      # 5Ô∏è‚É£ Security audit (non-blocking)
      - name: Security audit
        working-directory: ./erato-app/backend
        run: npm audit --audit-level=high || true
        continue-on-error: true

      # 6Ô∏è‚É£ Setup SSH to EC2
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_IP }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Test EC2 connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} \
              "echo 'Connection successful'"

      # 7Ô∏è‚É£ Detect project path on EC2
      - name: Detect project path
        id: detect-path
        run: |
          PROJECT_PATH=$(ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} \
            "if [ -d ~/erato-app ]; then echo ~/erato-app; \
             else find ~ -maxdepth 3 -type d -name 'erato-app' 2>/dev/null | head -1; fi")
          
          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå Could not detect project path on EC2"
            exit 1
          fi
          
          echo "project_path=$PROJECT_PATH" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected project path: $PROJECT_PATH"

      # 8Ô∏è‚É£ Pull latest code on EC2
      - name: Pull latest code
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} \
            "cd ${{ steps.detect-path.outputs.project_path }} && \
             git fetch origin && \
             git reset --hard origin/main && \
             git pull origin main"

      # 9Ô∏è‚É£ Rebuild and restart Docker container
      - name: Rebuild and restart backend
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} << 'EOF'
            PROJECT_PATH="${{ steps.detect-path.outputs.project_path }}"
            COMPOSE_FILE="docker-compose.prod.yml"
            
            cd "$PROJECT_PATH"
            
            docker-compose -f "$COMPOSE_FILE" stop backend 2>/dev/null || true
            docker-compose -f "$COMPOSE_FILE" rm -f backend 2>/dev/null || true
            
            docker system prune -af --volumes 2>/dev/null || true
            docker image prune -af 2>/dev/null || true
            
            docker-compose -f "$COMPOSE_FILE" up -d --build --force-recreate --no-deps backend
          EOF

      # üîü Wait for service to be ready
      - name: Wait for backend readiness
        run: |
          echo "Waiting for backend..."
          sleep 15
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.API_HEALTH_CHECK_URL }} || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Backend healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready (HTTP $HTTP_CODE)"
            sleep 5
          done
          echo "‚ö†Ô∏è Service not ready in time"
          exit 1

      # 1Ô∏è‚É£1Ô∏è‚É£ Final health check
      - name: Verify health
        run: |
          curl -f ${{ secrets.API_HEALTH_CHECK_URL }} || exit 1
          echo "‚úÖ Deployment successful"

      # 1Ô∏è‚É£2Ô∏è‚É£ Deployment summary
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL:** ${{ secrets.API_HEALTH_CHECK_URL }}" >> $GITHUB_STEP_SUMMARY
